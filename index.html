<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>PDF Word Highlighter + Piper TTS</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
        <link rel="manifest" href="manifest.webmanifest" />
        <meta name="theme-color" content="#2b2b2b" />

        <!-- Threads (activate CORS) -->
        <script src="./threads.js"></script>

        <!-- PDF.js -->
        <script src="thirdparty/pdf/pdf.js"></script>
        <script>
            pdfjsLib.GlobalWorkerOptions.workerSrc = "thirdparty/pdf/pdf.worker.js";
        </script>

        <!-- ONNX Runtime + Piper -->
        <script src="thirdparty/ort.js"></script>
        <script src="thirdparty/piper/piper-tts-proper.js"></script>

        <!-- pdf-lib for exporting annotated PDF -->
        <script src="thirdparty/pdf/pdf-lib.js"></script>

        <!-- Font Awesome -->
        <link rel="stylesheet" href="thirdparty/font-awesome/all.css" />
        <link rel="stylesheet" href="src/css/style.css" />

        <style></style>
    </head>
    <body>
        <script>
            if ("serviceWorker" in navigator) {
                navigator.serviceWorker
                    .register("service-worker.js")
                    .then((reg) => console.log("Service Worker registrado:", reg.scope))
                    .catch((err) => console.error("Erro no Service Worker:", err));
            }
        </script>

        <div id="controls" class="toolbar">
            <div class="btn-group">
                <button id="open-file" class="icon-btn" title="Open PDF (File Dialog)">
                    <i id="pdf-open" class="fa-solid fa-folder-open"></i>
                </button>
                <button id="export-highlights" class="icon-btn" title="Export PDF with highlights">
                    <i class="fa-solid fa-floppy-disk"></i>
                </button>
                <button id="toggle-view-mode" class="icon-btn" title="Toggle Full Document / Single Page">
                    <i class="fa-solid fa-clone"></i>
                </button>
                <button id="toggle-fullscreen" class="icon-btn" title="Toggle Full Screen">
                    <i class="fa-solid fa-expand"></i>
                </button>
            </div>

            <div class="btn-group">
                <button id="prev-page" class="icon-btn" title="Previous Page">
                    <i class="fa-solid fa-circle-left"></i>
                </button>
                <button id="prev-sentence" class="icon-btn" title="Previous Sentence (Arrow Left)">
                    <i class="fa-solid fa-backward" aria-hidden="true"></i>
                </button>
                <button id="play-toggle" class="icon-btn" data-state="play" title="Play / Pause (Space)">
                    <i class="fa-solid fa-play" aria-hidden="true" id="play-toggle-icon"></i>
                </button>
                <button id="next-sentence" class="icon-btn" title="Next Sentence (Arrow Right)">
                    <i class="fa-solid fa-forward" aria-hidden="true"></i>
                </button>
                <button id="next-page" class="icon-btn" title="Next Page">
                    <i class="fa-solid fa-circle-right"></i>
                </button>
            </div>

            <div class="btn-group" style="flex-wrap: wrap; gap: 6px">
                <input
                    style="margin-left: 20px; width: 50px; height: 5px"
                    type="color"
                    id="highlight-color"
                    value="#ffeb3b"
                    title="Highlight Color"
                    aria-label="Highlight Color"
                />
                <button id="save-highlight" class="icon-btn" title="Save current sentence highlight">
                    <i class="fa-solid fa-highlighter"></i>
                </button>
            </div>

            <div class="spacer" aria-hidden="true"></div>

            <div class="select-cluster">
                <div class="select-group" title="Voice">
                    <i id="mic-icon" class="fa-solid fa-spin fa-spinner" aria-hidden="true"></i>
                    <label for="voice-select" class="sr-only">Voice</label>
                    <select id="voice-select" aria-label="Voice"></select>
                </div>
                <div class="select-group" title="Playback Speed">
                    <i class="fa-solid fa-gauge-high" aria-hidden="true"></i>
                    <label for="rate-select" class="sr-only">Playback Speed</label>
                    <select id="rate-select" aria-label="Playback Speed">
                        <option value="1.0" selected>1.0x</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                        <option value="1.75">1.75x</option>
                        <option value="2.0">2.0x</option>
                    </select>
                </div>
            </div>
        </div>

        <div style="display: flex; gap: 10px">
            <div id="info-box" style="padding: 10px; flex: 1"></div>
            <div id="tts-status" style="padding: 10px; flex: 1"></div>
        </div>

        <div id="viewer-region">
            <div id="viewer-wrapper">
                <canvas id="pdf-canvas"></canvas>
            </div>
            <div id="pdf-doc-container" style="display: none"></div>
        </div>

        <input type="file" id="file-input" accept="application/pdf" style="display: none" />

        <div id="drop-overlay">Drop a PDF to read it!</div>

        <!-- App (modular) -->
        <script type="module">
            import { app } from "./src/app.js";
            window.initializePdfApp = () => app.initialize();
            window.loadPDF = (file, options) => app.loadPDF(file, options);
            window.toggleViewMode = () => app.toggleViewMode();
            window.nextSentence = () => app.nextSentence(true);
            window.prevSentence = () => app.prevSentence(true);
            window.playSentence = () => app.audioManager.playCurrentSentence();
            window.togglePlay = () => app.togglePlay();

            window.listSavedProgress = () => app.listSavedProgress();
            window.clearPdfProgress = (key) => app.clearPdfProgress(key);

            window.listSavedHighlights = () => app.listSavedHighlights();
            window.clearPdfHighlights = (key) => app.clearPdfHighlights(key);
            window.exportHighlights = () => app.exportPdfWithHighlights();
            window.saveHighlight = () => app.saveCurrentSentenceHighlight();

            window.addEventListener("DOMContentLoaded", async () => {
                await app.initialize();
            });
        </script>

        <script>
            const dropOverlay = document.getElementById("drop-overlay");
            let dragCounter = 0;
            window.addEventListener("dragenter", (e) => {
                e.preventDefault();
                dragCounter++;
                dropOverlay.classList.add("active");
            });
            window.addEventListener("dragover", (e) => e.preventDefault());
            window.addEventListener("dragleave", (e) => {
                e.preventDefault();
                dragCounter = Math.max(0, dragCounter - 1);
                if (!dragCounter) dropOverlay.classList.remove("active");
            });
            window.addEventListener("drop", async (e) => {
                e.preventDefault();
                dragCounter = 0;
                dropOverlay.classList.remove("active");
                const file = e.dataTransfer.files[0];
                if (file && /\.pdf$/i.test(file.name)) {
                    if (window.loadPDF) await window.loadPDF(file);
                } else alert("Not a valid PDF file!");
            });

            const fileInput = document.getElementById("file-input");
            document.getElementById("open-file").addEventListener("click", () => fileInput.click());
            fileInput.addEventListener("change", async (e) => {
                const file = e.target.files[0];
                if (file && /\.pdf$/i.test(file.name)) {
                    if (window.loadPDF) await window.loadPDF(file);
                } else alert("Not a valid PDF file!");
            });

            document.getElementById("toggle-view-mode").addEventListener("click", () => {
                if (window.toggleViewMode) window.toggleViewMode();
            });

            window.addEventListener("DOMContentLoaded", async () => {
                // if (window.initializePdfApp) await window.initializePdfApp();
                // else if (window.loadPDF) await window.loadPDF();
            });
        </script>
        <script>
            let wakeLock = null;
            const btn = document.getElementById("toggle-fullscreen");
            btn.addEventListener("click", () => {
                toggleFullscreen();
            });

            async function toggleFullscreen() {
                const doc = window.document;
                const docEl = doc.documentElement;
                const requestFull =
                    docEl.requestFullscreen ||
                    docEl.mozRequestFullScreen ||
                    docEl.webkitRequestFullscreen ||
                    docEl.msRequestFullscreen;
                const exitFull =
                    doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

                if (
                    !doc.fullscreenElement &&
                    !doc.mozFullScreenElement &&
                    !doc.webkitFullscreenElement &&
                    !doc.msFullscreenElement
                ) {
                    await requestFull.call(docEl);
                    enableWakeLock();
                } else {
                    await exitFull.call(doc);
                    disableWakeLock();
                }
            }

            async function enableWakeLock() {
                try {
                    if ("wakeLock" in navigator) {
                        wakeLock = await navigator.wakeLock.request("screen");
                        wakeLock.addEventListener("release", () => {});
                    }
                } catch (err) {
                    console.error(`${err.name}, ${err.message}`);
                }
            }
            function disableWakeLock() {
                if (wakeLock) {
                    wakeLock.release();
                    wakeLock = null;
                }
            }
        </script>
    </body>
</html>

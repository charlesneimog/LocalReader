<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Piper TTS Worker Demo</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>
            body {
                font-family:
                    system-ui,
                    -apple-system,
                    Segoe UI,
                    Roboto,
                    Arial,
                    sans-serif;
                padding: 16px;
            }
            label {
                display: block;
                margin: 8px 0 4px;
            }
            input[type="text"],
            textarea {
                width: 100%;
                max-width: 800px;
                padding: 8px;
            }
            button {
                padding: 8px 12px;
                margin-right: 8px;
            }
            .row {
                margin: 12px 0;
            }
            code {
                background: #f4f4f4;
                padding: 2px 4px;
                border-radius: 4px;
            }
        </style>
    </head>
    <body>
        <h1>Piper TTS with WebWorker</h1>

        <p>
            This demo initializes Piper TTS in a WebWorker, loading both the ONNX model and the phonemizer inside the
            worker. The main thread downloads the voice model and config, then transfers them to the worker.
        </p>

        <div class="row">
            <label for="text">Text</label>
            <textarea id="text" rows="3">Hello from Piper TTS running entirely inside a WebWorker!</textarea>
        </div>

        <div class="row">
            <label for="speed">Speed (1.0 is normal)</label>
            <input id="speed" type="number" min="0.5" max="2" step="0.1" value="1.0" />
        </div>

        <div class="row">
            <button id="initBtn">Initialize</button>
            <button id="speakBtn" disabled>Speak</button>
            <button id="downloadWavBtn" disabled>Download WAV</button>
        </div>

        <div class="row">
            <audio id="audio" controls></audio>
        </div>

        <hr />

        <details>
            <summary>Advanced configuration</summary>
            <div class="row">
                <label>ONNX Runtime (worker) JS URL</label>
                <input
                    id="ortJsUrl"
                    type="text"
                    value="https://cdnjs.cloudflare.com/ajax/libs/onnxruntime-web/1.23.0/ort.min.js"
                />
            </div>
            <div class="row">
                <label>ONNX Runtime wasm root</label>
                <input id="ortWasmRoot" type="text" value="https://cdnjs.cloudflare.com/ajax/libs/onnxruntime-web/1.23.0/"
            </div>
            <div class="row">
                <label>Piper phonemizer JS URL</label>
                <input id="phonemizerJsUrl" type="text" value="./thirdparty/piper/piper-o91UDS6e.js" />
            </div>
            <div class="row">
                <label>Piper phonemizer WASM URL</label>
                <input id="phonemizerWasmUrl" type="text" value="./thirdparty/piper/piper_phonemize.wasm" />
            </div>
            <div class="row">
                <label>Piper phonemizer DATA URL</label>
                <input id="phonemizerDataUrl" type="text" value="./thirdparty/piper/piper_phonemize.data" />
            </div>
            <p>Note: Make sure the phonemizer assets exist at the paths above. They are loaded by the worker.</p>
        </details>

        <script src="./piper-client.js"></script>
        <script>
            // Hugging Face voice files (use "resolve/main" for direct file content)
            const MODEL_URL =
                "https://huggingface.co/rhasspy/piper-voices/resolve/main/en/en_US/hfc_male/medium/en_US-hfc_male-medium.onnx";
            const CONFIG_URL =
                "https://huggingface.co/rhasspy/piper-voices/resolve/main/en/en_US/hfc_male/medium/en_US-hfc_male-medium.onnx.json";

            const initBtn = document.getElementById("initBtn");
            const speakBtn = document.getElementById("speakBtn");
            const downloadWavBtn = document.getElementById("downloadWavBtn");
            const textEl = document.getElementById("text");
            const speedEl = document.getElementById("speed");
            const audioEl = document.getElementById("audio");

            const ortJsUrlEl = document.getElementById("ortJsUrl");
            const ortWasmRootEl = document.getElementById("ortWasmRoot");
            const phonemizerJsUrlEl = document.getElementById("phonemizerJsUrl");
            const phonemizerWasmUrlEl = document.getElementById("phonemizerWasmUrl");
            const phonemizerDataUrlEl = document.getElementById("phonemizerDataUrl");

            const client = new PiperWorkerClient({ workerUrl: "./piper.worker.js" });

            let lastWavBlob = null;

            initBtn.addEventListener("click", async () => {
                initBtn.disabled = true;
                try {
                    // Download/cached model & config on main thread
                    const modelBuffer = await getCachedModel("en_US-hfc_male-medium.onnx", MODEL_URL);
                    const voiceConfig = await getCachedJSON("en_US-hfc_male-medium.onnx.json", CONFIG_URL);

                    const ortJsUrl = ortJsUrlEl.value.trim();
                    const ortWasmRoot = ortWasmRootEl.value.trim();
                    const phonemizerJsUrl = phonemizerJsUrlEl.value.trim();
                    const phonemizerWasmUrl = phonemizerWasmUrlEl.value.trim();
                    const phonemizerDataUrl = phonemizerDataUrlEl.value.trim();

                    const { threads, simd } = await client.init({
                        modelBuffer,
                        voiceConfig,
                        ortJsUrl,
                        ortWasmRoot,
                        phonemizerJsUrl,
                        phonemizerWasmUrl,
                        phonemizerDataUrl,
                        logLevel: "error",
                        transferModel: true, // transfers the ArrayBuffer to the worker (zero-copy)
                    });

                    console.log(`Worker initialized. threads=${threads}, simd=${simd}`);
                    speakBtn.disabled = false;
                } catch (err) {
                    console.error("Failed to initialize:", err);
                    alert("Init error: " + err.message);
                    initBtn.disabled = false;
                }
            });

            speakBtn.addEventListener("click", async () => {
                try {
                    const text = textEl.value;
                    const speed = parseFloat(speedEl.value) || 1.0;

                    const { blob } = await client.synthesize(text, speed);
                    lastWavBlob = blob;

                    const url = URL.createObjectURL(blob);
                    audioEl.src = url;
                    try {
                        await audioEl.play();
                    } catch (e) {
                        console.warn("Autoplay blocked; click play on the audio control.");
                    }
                    downloadWavBtn.disabled = false;
                } catch (err) {
                    console.error("Speak error:", err);
                    alert("Speak error: " + err.message);
                }
            });

        </script>
    </body>
</html>

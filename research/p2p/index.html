<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <title>P2P Local com QR e Scanner</title>
        <style>
            body {
                font-family: sans-serif;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            video {
                width: 300px;
                height: 225px;
                background: black;
                margin: 10px;
            }
            #qr {
                margin: 20px;
            }
            #reader {
                width: 300px;
                margin: 10px;
            }
            button {
                margin: 5px;
                padding: 8px 12px;
            }
        </style>
    </head>
    <body>
        <h1>P2P Local com QR e Scanner</h1>

        <div>
            <h3>Peer A (Computador)</h3>
            <video id="localVideo" autoplay muted></video>
            <canvas id="qr"></canvas>
        </div>

        <div>
            <h3>Peer B (Smartphone)</h3>
            <div id="reader"></div>
            <video id="remoteVideo" autoplay></video>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"
            integrity="sha512-r6rDA7W6ZeQhvl8S7yRVQUKVHdexq+GAlNkNNqVC7YyIV+NwqCTJe2hDWCiffTyRNOeGEzRRJ9ifvRm/HCzGYg=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        ></script>

        <script>
            let localStream;
            let pcA = new RTCPeerConnection();
            let pcB = new RTCPeerConnection();

            // ===== Peer A (gera offer e QR) =====
            const localVideo = document.getElementById("localVideo");
            navigator.mediaDevices.getUserMedia({ video: true, audio: false }).then((stream) => {
                localStream = stream;
                localVideo.srcObject = stream;
                stream.getTracks().forEach((track) => pcA.addTrack(track, stream));
            });

            pcA.onicecandidate = (e) => {
                if (e.candidate) console.log("A ICE candidate:", e.candidate);
            };
            pcA.ontrack = (e) => console.log("A recebeu track", e.streams[0]);

            async function generateOfferQR() {
                const offer = await pcA.createOffer();
                await pcA.setLocalDescription(offer);
                const offerJSON = JSON.stringify(pcA.localDescription);
                QRCode.toCanvas(document.getElementById("qr"), offerJSON, { width: 300 });
            }
            generateOfferQR();

            // ===== Peer B (scanner QR) =====
            const remoteVideo = document.getElementById("remoteVideo");

            pcB.ontrack = (e) => {
                remoteVideo.srcObject = e.streams[0];
            };

            async function connectToOffer(offerJSON) {
                const offer = JSON.parse(offerJSON);
                await pcB.setRemoteDescription(offer);
                const answer = await pcB.createAnswer();
                await pcB.setLocalDescription(answer);

                // Adiciona track opcional de retorno
                if (localStream) localStream.getTracks().forEach((t) => pcB.addTrack(t, localStream));

                pcB.onicecandidate = (e) => {
                    if (e.candidate) console.log("B ICE candidate:", e.candidate);
                };

                pcA.setRemoteDescription(answer);
                console.log("ConexÃ£o estabelecida na rede local!");
            }

            // ===== HTML5 QR Code Scanner =====
            const html5QrCode = new Html5Qrcode("reader");

            function startScanner() {
                html5QrCode.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: { width: 300, height: 300 } },
                    (decodedText) => {
                        console.log("QR Lido:", decodedText);
                        connectToOffer(decodedText);
                        html5QrCode.stop();
                    },
                    (errorMessage) => {},
                );
            }

            startScanner();
        </script>
    </body>
</html>

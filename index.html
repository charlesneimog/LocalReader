<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>PDF Word Highlighter + Piper TTS</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

        <!-- Threads (if needed) -->
        <script src="./threads.js"></script>

        <!-- PDF.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
        <script>
            pdfjsLib.GlobalWorkerOptions.workerSrc =
                "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.worker.min.js";
        </script>

        <!-- ONNX Runtime + Piper -->
        <script src="thirdparty/ort.min.js"></script>
        <script src="thirdparty/piper/piper-tts-proper.js"></script>

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

        <style>
            :root {
                --bg-light: #ffffff;
                --fg-light: #111;
                --bg-dark: #1f1f1f;
                --fg-dark: #f5f5f5;
                --border-light: #d0d4d9;
                --border-dark: #3a3f46;
                --accent-gradient: linear-gradient(135deg, #ffb347, #ffcc33);
                --accent-solid: #ffb347;
                --btn-bg-light: #f5f7fa;
                --btn-bg-dark: #2b2f34;
                --shadow-color-light: rgba(0, 0, 0, 0.08);
                --shadow-color-dark: rgba(0, 0, 0, 0.6);
                --focus-ring: 0 0 0 3px rgba(0, 140, 255, 0.45);
            }
            @media (prefers-color-scheme: light) {
                :root {
                    --bg: var(--bg-light);
                    --fg: var(--fg-light);
                    --border: var(--border-light);
                    --panel-bg: rgba(255, 255, 255, 0.75);
                    --panel-border: rgba(0, 0, 0, 0.08);
                    --btn-bg: var(--btn-bg-light);
                    --btn-bg-hover: #eef1f5;
                    --btn-bg-active: #e2e6eb;
                    --info-color: #333;
                    --subtitle-color: #555;
                }
            }
            @media (prefers-color-scheme: dark) {
                :root {
                    --bg: var(--bg-dark);
                    --fg: var(--fg-dark);
                    --border: var(--border-dark);
                    --panel-bg: rgba(40, 40, 44, 0.68);
                    --panel-border: rgba(255, 255, 255, 0.08);
                    --btn-bg: var(--btn-bg-dark);
                    --btn-bg-hover: #353b42;
                    --btn-bg-active: #40464e;
                    --info-color: #e0e0e0;
                    --subtitle-color: #a8a8a8;
                }
                /* If you want to invert single-canvas only, keep this.
         For full-doc mode with colored highlights, you may prefer to remove it. */
                /* #pdf-canvas { filter: invert(.85); } */
            }
            html,
            body {
                margin: 0;
                padding: 0;
                font-family:
                    system-ui,
                    -apple-system,
                    Segoe UI,
                    Roboto,
                    Ubuntu,
                    Cantarell,
                    "Noto Sans",
                    Arial,
                    sans-serif;
                background: var(--bg);
                color: var(--fg);
                -webkit-font-smoothing: antialiased;
                height: 100vh;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            #controls.toolbar {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                align-items: center;
                padding: 10px 14px;
                background: var(--panel-bg);
                backdrop-filter: blur(14px) saturate(1.4);
                -webkit-backdrop-filter: blur(14px) saturate(1.4);
                border-bottom: 1px solid var(--panel-border);
                box-shadow:
                    0 4px 14px -4px var(--shadow-color-light),
                    0 2px 4px -1px var(--shadow-color-light);
                transition: background 0.35s;
                position: relative;
                z-index: 10;
            }
            @media (prefers-color-scheme: dark) {
                #controls.toolbar {
                    box-shadow:
                        0 4px 18px -6px var(--shadow-color-dark),
                        0 2px 6px -2px var(--shadow-color-dark);
                }
            }

            button,
            select {
                font: inherit;
                border: 1px solid var(--border);
                background: var(--btn-bg);
                color: var(--fg);
                padding: 8px 12px;
                border-radius: 10px;
                cursor: pointer;
                font-size: 14px;
                line-height: 1;
                display: inline-flex;
                align-items: center;
                gap: 8px;
                position: relative;
                transition:
                    background 0.25s,
                    border-color 0.25s,
                    transform 0.15s;
                min-height: 40px;
            }
            button:focus-visible,
            select:focus-visible {
                outline: none;
                box-shadow: var(--focus-ring);
            }
            button:hover:not(:disabled),
            select:hover:not(:disabled) {
                background: var(--btn-bg-hover);
            }
            button:active:not(:disabled) {
                background: var(--btn-bg-active);
                transform: translateY(1px);
            }
            button:disabled {
                opacity: 0.55;
                cursor: not-allowed;
            }

            .icon-btn {
                padding-inline: 14px;
                font-weight: 500;
            }
            .icon-btn .label {
                font-size: 13px;
                letter-spacing: 0.3px;
            }
            .icon-btn i {
                font-size: 15px;
                width: 16px;
                text-align: center;
            }

            .select-cluster {
                display: flex;
                align-items: center;
                gap: 14px;
                flex-wrap: wrap;
            }
            .select-group {
                display: flex;
                align-items: center;
                gap: 8px;
                background: var(--btn-bg);
                border: 1px solid var(--border);
                padding: 4px 10px;
                border-radius: 12px;
                transition:
                    background 0.25s,
                    border-color 0.25s;
            }
            .select-group:hover {
                background: var(--btn-bg-hover);
            }
            .select-group:focus-within {
                box-shadow: var(--focus-ring);
            }
            .select-group i {
                font-size: 15px;
                opacity: 0.85;
            }
            .select-group select {
                background: transparent;
                border: none;
                padding: 0;
                font-size: 13px;
                height: 26px;
            }
            .select-group select:focus {
                outline: none;
                box-shadow: none;
            }

            .sr-only {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0 0 0 0);
                white-space: nowrap;
                border: 0;
            }

            #info-box,
            #tts-status {
                text-align: center;
                font-size: 13px;
                padding: 4px 10px;
                color: var(--info-color);
                min-height: 20px;
            }
            #progress-prefetch {
                width: 260px;
                height: 6px;
                background: var(--btn-bg);
                border-radius: 5px;
                overflow: hidden;
                margin: 2px auto 8px;
                position: relative;
                border: 1px solid var(--border);
            }
            #progress-prefetch span {
                position: absolute;
                inset: 0;
                width: 0%;
                background: var(--accent-gradient);
                transition: width 0.35s ease;
            }
            #subtitle-preview {
                font-size: 11px;
                text-align: center;
                color: var(--subtitle-color);
                max-width: 1000px;
                margin: 0 auto;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                font-family: "Courier New", monospace;
                padding: 12px 6px;
                margin: 0px 24px;
            }

            /* Viewer layout container */
            #viewer-region {
                flex: 1 1 auto;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                position: relative;
                margin: 40px;
            }

            /* Single-canvas wrapper */
            #viewer-wrapper {
                flex: 1 1 auto;
                display: flex;
                justify-content: center;
                overflow: auto;
                padding: 12px 0 24px;
            }
            #pdf-canvas {
                border: 1px solid var(--border);
                border-radius: 14px;
                background: var(--bg);
                display: block;
                box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.25);
                max-width: calc(100vw - 40px);
            }

            /* Full document container */
            #pdf-doc-container {
                flex: 1 1 auto;
                position: relative;
                overflow-y: auto;
                overflow-x: hidden;
                background: var(--bg);
                padding: 24px 0 48px;
                margin: 0;
                border-top: 1px solid var(--panel-border);
                scroll-behavior: smooth;
            }
            body.dark #pdf-doc-container {
                background: #2a2d30;
            }
            .pdf-page-wrapper {
                position: relative;
                margin: 0 auto 32px auto;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
                background: #fff;
                border-radius: 6px;
                overflow: hidden;
                transition: box-shadow 0.25s;
            }
            .pdf-page-wrapper:hover {
                box-shadow: 0 4px 14px rgba(0, 0, 0, 0.25);
            }
            .pdf-word-highlight {
                position: absolute;
                background: rgba(255, 255, 0, 0.28);
                pointer-events: none;
                border-radius: 2px;
            }

            canvas {
                filter: invert(0.95);
            }

            /* Drag & Drop overlay */
            #drop-overlay {
                position: fixed;
                inset: 0;
                background: radial-gradient(circle at 50% 50%, rgba(0, 150, 255, 0.25), rgba(0, 150, 255, 0.1));
                border: 3px dashed #0096ff;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: clamp(1.5rem, 3.5vw, 2.4rem);
                font-weight: 600;
                color: #0096ff;
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.25s ease;
                z-index: 1000;
                backdrop-filter: blur(6px);
            }
            #drop-overlay.active {
                opacity: 1;
            }

            .toolbar .btn-group {
                display: flex;
                gap: 8px;
                align-items: stretch;
            }
            .toolbar .spacer {
                flex: 1 1 auto;
                min-width: 40px;
            }

            @media (max-width: 680px) {
                .icon-btn .label {
                    display: none;
                }
                #controls.toolbar {
                    padding: 8px 10px;
                }
                .select-group {
                    padding: 4px 10px;
                }
            }

            /* MOBILE-FRIENDLY IMPROVEMENTS */
            @media (max-width: 680px) {
                html,
                body {
                    font-size: 15px;
                    min-width: 0;
                    height: 100dvh;
                    overflow: auto !important;
                }
                #controls.toolbar {
                    flex-direction: column;
                    align-items: stretch;
                    padding: 8px 4px;
                    gap: 0;
                }
                .toolbar .btn-group,
                .select-cluster {
                    flex-direction: row;
                    gap: 2px;
                    justify-content: center;
                    width: 100%;
                    margin-bottom: 6px;
                }
                .select-group {
                    flex: 1 1 100%;
                    min-width: 0;
                    padding: 4px 4px;
                    margin: 2px 0;
                }
                button,
                select {
                    width: 100%;
                    min-width: 0;
                    min-height: 46px;
                    font-size: 17px;
                    padding: 12px 6px;
                    box-sizing: border-box;
                    border-radius: 14px;
                }
                .icon-btn .label {
                    display: none;
                }
                #viewer-region {
                    margin: 0;
                    padding: 0;
                    height: 100%;
                    min-height: 0;
                    flex: 1 1 auto;
                }
                #subtitle-preview {
                    max-width: 96vw;
                    padding: 4px 2vw 4px 2vw;
                    font-size: 13px;
                    margin: 2px 0 6px 0;
                }
                #info-box,
                #tts-status {
                    font-size: 14px;
                    padding: 4px;
                    min-height: 18px;
                }
                #progress-prefetch {
                    width: 90vw;
                    min-width: 90vw;
                    margin: 4px auto 4px auto;
                }
                #viewer-wrapper,
                #pdf-doc-container {
                    padding: 0 !important;
                    margin: 0 !important;
                    max-width: 100vw;
                    width: 100vw;
                    min-height: 0;
                    height: auto;
                }
                #pdf-canvas {
                    max-width: 100vw;
                    width: 100vw;
                    height: auto;
                    border-radius: 0;
                }
                .pdf-page-wrapper {
                    margin: 0 auto 18px auto;
                    border-radius: 4px;
                    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.12);
                    width: 100vw !important;
                    max-width: 100vw !important;
                }
                canvas {
                    max-width: 100vw !important;
                    width: 100vw !important;
                    height: auto !important;
                }
                #drop-overlay {
                    font-size: clamp(1.2rem, 6vw, 2.1rem);
                    padding: 0 6vw;
                }
            }

            /* Extra: landscape or super small screens */
            @media (max-width: 420px) {
                #controls.toolbar {
                    padding: 4px 0;
                }
                button,
                select {
                    font-size: 14px;
                    padding: 8px 2px;
                    border-radius: 10px;
                }
                #subtitle-preview {
                    font-size: 11px;
                }
            }

            /* Make sure the app is scrollable if space is tight */
            body,
            html {
                overflow: auto !important;
                min-height: 100dvh;
                height: 100dvh;
            }
        </style>
    </head>
    <body>
        <div id="controls" class="toolbar">
            <div class="btn-group">
                <button id="open-file" class="icon-btn" title="Open PDF (File Dialog)">
                    <i class="fa-solid fa-folder-open"></i><span class="label">Open</span>
                </button>
                <button id="toggle-view-mode" class="icon-btn" title="Toggle Full Document / Single Page">
                    <i class="fa-solid fa-clone"></i><span class="label">View: Full Doc</span>
                </button>
            </div>

            <div class="btn-group">
                <button id="prev-page" class="icon-btn" title="Previous Page">
                    <i class="fa-solid fa-circle-left"></i><span class="label">Prev Page</span>
                </button>
                <button id="prev-sentence" class="icon-btn" title="Previous Sentence (Arrow Left)">
                    <i class="fa-solid fa-backward" aria-hidden="true"></i><span class="label">Prev</span>
                </button>
                <button id="play-toggle" class="icon-btn" data-state="play" title="Play / Pause (Space)">
                    <i class="fa-solid fa-play" aria-hidden="true" id="play-toggle-icon"></i>
                    <span class="label" id="play-toggle-label">Play</span>
                </button>
                <button id="next-sentence" class="icon-btn" title="Next Sentence (Arrow Right)">
                    <i class="fa-solid fa-forward" aria-hidden="true"></i><span class="label">Next</span>
                </button>
                <button id="next-page" class="icon-btn" title="Next Page">
                    <i class="fa-solid fa-circle-right"></i><span class="label">Next Page</span>
                </button>
            </div>

            <div class="spacer" aria-hidden="true"></div>

            <div class="select-cluster">
                <div class="select-group" title="Voice">
                    <i id="mic-icon" class="fa-solid fa-spin fa-spinner" aria-hidden="true"></i>
                    <label for="voice-select" class="sr-only">Voice</label>
                    <select id="voice-select" aria-label="Voice"></select>
                </div>

                <div class="select-group" title="Playback Speed">
                    <i class="fa-solid fa-gauge-high" aria-hidden="true"></i>
                    <label for="rate-select" class="sr-only">Playback Speed</label>
                    <select id="rate-select" aria-label="Playback Speed">
                        <option value="1.0" selected>1.0x</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                        <option value="1.75">1.75x</option>
                        <option value="2.0">2.0x</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="info-box"></div>
        <div id="tts-status"></div>
        <div id="progress-prefetch"><span id="prefetch-bar"></span></div>
        <div id="subtitle-preview"></div>

        <div id="viewer-region">
            <!-- Single page (legacy) canvas -->
            <div id="viewer-wrapper">
                <canvas id="pdf-canvas"></canvas>
            </div>
            <!-- Full document container (hidden initially; JS will manage display) -->
            <div id="pdf-doc-container" style="display: none"></div>
        </div>

        <input type="file" id="file-input" accept="application/pdf" style="display: none" />

        <div id="drop-overlay">Drop a PDF to read it!</div>

        <!-- Main logic -->
        <script type="module" src="render.js"></script>
        <script>
            // Drag & Drop overlay with counter to avoid flicker
            const dropOverlay = document.getElementById("drop-overlay");
            let dragCounter = 0;
            window.addEventListener("dragenter", (e) => {
                e.preventDefault();
                dragCounter++;
                dropOverlay.classList.add("active");
            });
            window.addEventListener("dragover", (e) => e.preventDefault());
            window.addEventListener("dragleave", (e) => {
                e.preventDefault();
                dragCounter = Math.max(0, dragCounter - 1);
                if (dragCounter === 0) dropOverlay.classList.remove("active");
            });
            window.addEventListener("drop", async (e) => {
                e.preventDefault();
                dragCounter = 0;
                dropOverlay.classList.remove("active");
                const file = e.dataTransfer.files[0];
                if (file && /(\.pdf)$/i.test(file.name)) {
                    if (window.loadPDF) {
                        await window.loadPDF(file);
                    }
                } else {
                    alert("Not a valid PDF file!");
                }
            });

            const fileInput = document.getElementById("file-input");
            const openBtn = document.getElementById("open-file");
            openBtn.addEventListener("click", () => fileInput.click());

            fileInput.addEventListener("change", async (e) => {
                const file = e.target.files[0];
                if (file && /(\.pdf)$/i.test(file.name)) {
                    if (window.loadPDF) {
                        await window.loadPDF(file);
                    }
                } else {
                    alert("Not a valid PDF file!");
                }
            });

            // View mode toggle (Full vs Single)
            const toggleViewBtn = document.getElementById("toggle-view-mode");
            toggleViewBtn.addEventListener("click", () => {
                if (window.toggleViewMode) {
                    window.toggleViewMode();
                }
            });

            // Auto load after scripts register globals
            window.addEventListener("DOMContentLoaded", async () => {
                if (window.initializePdfApp) {
                    await window.initializePdfApp();
                } else if (window.loadPDF) {
                    await window.loadPDF(); // fallback
                }
            });
        </script>
    </body>
</html>

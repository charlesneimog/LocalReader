<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>PDF Word Highlighter + Piper TTS</title>

        <!-- PDF.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
        <script>
            pdfjsLib.GlobalWorkerOptions.workerSrc =
                "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.worker.min.js";
        </script>

        <!-- ONNX Runtime + Piper (must exist locally if you host offline) -->
        <script src="thirdparty/ort.min.js"></script>
        <script src="thirdparty/piper/piper-tts-proper.js"></script>

        <style>
            :root {
                --bg-light: #fff;
                --fg-light: #000;
                --bg-dark: #303030;
                --fg-dark: rgba(255, 255, 255, 0.9);
                --accent: linear-gradient(90deg, #ffaf00, #ffcc33);
            }

            @media (prefers-color-scheme: light) {
                :root {
                    --bg: var(--bg-light);
                    --fg: var(--fg-light);
                    --border: #333;
                    --info-color: #333;
                    --subtitle-color: #555;
                }
            }

            @media (prefers-color-scheme: dark) {
                :root {
                    --bg: var(--bg-dark);
                    --fg: var(--fg-dark);
                    --border: #ccc;
                    --info-color: #ddd;
                    --subtitle-color: #aaa;
                }
                canvas {
                    filter: invert(0.85);
                }
            }

            html,
            body {
                margin: 0;
                padding: 0;
                overflow: hidden;
                font-family: Arial, sans-serif;
                background: var(--bg);
                color: var(--fg);
            }

            #controls {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 6px;
                padding: 10px 10px 4px;
            }

            button,
            select,
            input[type="file"] {
                padding: 6px 10px;
                border-radius: 6px;
                background: var(--bg);
                color: var(--fg);
                border: 1px solid var(--border);
                cursor: pointer;
                font-size: 14px;
            }

            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            #info-box,
            #tts-status {
                text-align: center;
                font-size: 13px;
                padding: 4px 10px 4px;
                color: var(--info-color);
                min-height: 20px;
            }

            #progress-prefetch {
                width: 240px;
                height: 6px;
                background: var(--bg);
                border-radius: 4px;
                overflow: hidden;
                margin: 0 auto 6px;
                position: relative;
            }

            #progress-prefetch span {
                position: absolute;
                left: 0;
                top: 0;
                height: 100%;
                width: 0%;
                background: var(--accent);
                transition: width 0.25s ease;
            }

            #subtitle-preview {
                font-size: 11px;
                text-align: center;
                color: var(--subtitle-color);
                max-width: 900px;
                margin: 0 auto;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                font-family: "Courier New", monospace;
            }

            #viewer-wrapper {
                width: 100%;
                display: flex;
                justify-content: center;
                padding-bottom: 12px;
            }

            #pdf-canvas {
                border: 1px solid var(--border);
                border-radius: 10px;
                background: var(--bg);
                display: block;
            }

            #drop-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 150, 255, 0.2);
                border: 3px dashed #0096ff;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 2rem;
                color: #0096ff;
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.2s;
                z-index: 1000;
            }

            #drop-overlay.active {
                opacity: 1;
            }
        </style>
    </head>
    <body>
        <div id="controls">
            <button id="prev-sentence">← Prev Sentence</button>
            <button id="next-sentence">Next Sentence →</button>
            <button id="play-toggle">▶️ Play</button>

            <label for="language-select" title="Static placeholder for legacy UI">Lang:</label>
            <select id="language-select" title="Not used for Piper filtering"></select>

            <label for="voice-select">Voice:</label>
            <select id="voice-select"></select>

            <select id="rate-select" title="Speed (mapped from % to factor)">
                <option value="+0%">speed +0%</option>
                <option value="+10%">speed +10%</option>
                <option value="+15%">speed +15%</option>
                <option value="+30%" selected>speed +30%</option>
                <option value="-10%">speed -10%</option>
            </select>
        </div>

        <div id="info-box"></div>
        <div id="tts-status"></div>
        <div id="progress-prefetch"><span id="prefetch-bar"></span></div>
        <div id="subtitle-preview"></div>

        <div id="viewer-wrapper">
            <canvas id="pdf-canvas"></canvas>
        </div>

        <div id="drop-overlay">Drop a PDF to read it!</div>

        <!-- Main logic -->
        <script type="module" src="render.js"></script>

        <script>
            // Auto-load default PDF
            window.addEventListener("DOMContentLoaded", () => {
                if (window.loadPDF) {
                    window.loadPDF();
                }
            });

            // Drag & Drop
            const dropOverlay = document.getElementById("drop-overlay");
            window.addEventListener("dragenter", (e) => {
                e.preventDefault();
                dropOverlay.classList.add("active");
            });
            window.addEventListener("dragleave", (e) => {
                e.preventDefault();
                dropOverlay.classList.remove("active");
            });
            window.addEventListener("dragover", (e) => e.preventDefault());
            window.addEventListener("drop", async (e) => {
                e.preventDefault();
                dropOverlay.classList.remove("active");

                const file = e.dataTransfer.files[0];
                if (file && (file.type === "application/pdf" || file.name.toLowerCase().endsWith(".pdf"))) {
                    if (window.loadPDF) {
                        await window.loadPDF(file);
                        console.log("PDF loaded via drag & drop");
                    }
                } else {
                    alert("Not a valid PDF file!");
                }
            });
        </script>
    </body>
</html>


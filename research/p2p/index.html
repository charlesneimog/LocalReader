<!doctype html>
<meta charset="utf-8" />
<title>WebRTC P2P LAN via Token</title>
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode"></script>
<script>
    const log = (s) => {
        const el = document.getElementById("log");
        el.textContent += s + "\n";
        el.scrollTop = el.scrollHeight;
    };

    let pc = null,
        dc = null;
    let isHost = false;
    let token = "";

    // --- Gerar token e QR
    document.getElementById("hostStart").onclick = () => {
        isHost = true;
        token = Math.floor(10000000 + Math.random() * 90000000).toString();
        document.getElementById("hostToken").textContent = token;
        log("Token gerado: " + token);
        document.getElementById("tokenQR").textContent = token;
        startConnection();
    };

    // --- Cliente lê QR (simulação com input)
    document.getElementById("clientConnect").onclick = () => {
        isHost = false;
        token = document.getElementById("clientToken").value.trim();
        if (!token) {
            alert("Insira token");
            return;
        }
        log("Token lido: " + token);
        startConnection();
    };

    // --- Inicia PeerConnection
    function startConnection() {
        pc = new RTCPeerConnection({ iceServers: [] });

        if (isHost) {
            dc = pc.createDataChannel("p2p");
            setupDC(dc);
        } else {
            pc.ondatachannel = (e) => {
                dc = e.channel;
                setupDC(dc);
            };
        }

        pc.onicecandidate = (e) => {
            if (e.candidate && dc && dc.readyState === "open") {
                // envia candidato via DataChannel assim que abrir
                dc.send(JSON.stringify({ type: "ice", candidate: e.candidate }));
            }
        };

        if (isHost) {
            pc.createOffer()
                .then((o) => pc.setLocalDescription(o))
                .then(() => {
                    log("Offer criada. Aguardando cliente abrir DataChannel...");
                });
        } else {
            // Cliente aguarda oferta via LAN DataChannel (simulação: oferta é enviada manualmente)
            log("Cliente pronto. Esperando host iniciar conexão...");
        }
    }

    // --- Setup DataChannel
    function setupDC(ch) {
        ch.onopen = () => {
            log("DataChannel aberto");
            if (isHost) ch.send(JSON.stringify({ type: "auth", token: token }));
        };
        ch.onmessage = (e) => {
            try {
                const msg = JSON.parse(e.data);
                if (msg.type === "auth") {
                    if (msg.token === token) {
                        log("Token correto! Conexão autenticada.");
                    } else {
                        log("Token incorreto. Fechando...");
                        ch.close();
                    }
                } else if (msg.type === "chat") {
                    log("<< " + msg.text);
                } else if (msg.type === "ice") {
                    pc.addIceCandidate(msg.candidate);
                }
            } catch (err) {
                log("<< " + e.data);
            }
        };
    }

    // --- Chat
    document.getElementById("send").onclick = () => {
        const t = document.getElementById("msg").value;
        if (!dc || dc.readyState !== "open") {
            alert("DataChannel não aberto");
            return;
        }
        dc.send(JSON.stringify({ type: "chat", text: t }));
        log(">> " + t);
        document.getElementById("msg").value = "";
    };
</script>

<style>
    body {
        font-family:
            system-ui,
            Segoe UI,
            Roboto,
            Arial;
        margin: 18px;
    }
    button {
        margin: 4px;
    }
    input {
        margin: 4px;
    }
    pre {
        height: 200px;
        overflow: auto;
        background: #f7f7f7;
        padding: 8px;
    }
    #tokenQR {
        font-size: 24px;
        font-weight: bold;
        margin: 6px 0;
    }
</style>

<h2>WebRTC P2P LAN via Token</h2>

<div>
    <h3>Host</h3>
    <button id="hostStart">Gerar Token e QR</button>
    <div>Token: <span id="hostToken"></span></div>
    <div id="tokenQR"></div>
</div>

<div>
    <h3>Cliente</h3>
    <input id="clientToken" placeholder="Insira token do Host" />
    <button id="clientConnect">Conectar</button>
</div>

<div>
    <h3>Chat</h3>
    <input id="msg" placeholder="mensagem" style="width: 70%" />
    <button id="send">Enviar</button>
    <pre id="log"></pre>
</div>

<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>PDF Word Highlighter + Piper TTS</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
        <link rel="manifest" href="manifest.webmanifest" />
        <meta name="theme-color" content="#2b2b2b" />

        <!-- Threads (if needed) -->
        <script src="./threads.js"></script>

        <!-- PDF.js -->
        <script src="thirdparty/pdf/pdf.js"></script>
        <script>
            pdfjsLib.GlobalWorkerOptions.workerSrc = "thirdparty/pdf/pdf.worker.js";
        </script>

        <!-- ONNX Runtime + Piper -->
        <script src="thirdparty/ort.js"></script>
        <script src="thirdparty/piper/piper-tts-proper.js"></script>

        <!-- pdf-lib for exporting annotated PDF -->
        <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

        <!-- Font Awesome -->
        <link rel="stylesheet" href="thirdparty/font-awesome/all.css" />

        <style>
            :root {
                --bg-light: #ffffff;
                --fg-light: #111;
                --bg-dark: #1f1f1f;
                --fg-dark: #f5f5f5;
                --border-light: #d0d4d9;
                --border-dark: #3a3f46;
                --accent-gradient: linear-gradient(135deg, #ffb347, #ffcc33);
                --accent-solid: #ffb347;
                --btn-bg-light: #f5f7fa;
                --btn-bg-dark: #2b2f34;
                --shadow-color-light: rgba(0, 0, 0, 0.08);
                --shadow-color-dark: rgba(0, 0, 0, 0.6);
                --focus-ring: 0 0 0 3px rgba(0, 140, 255, 0.45);
            }
            @media (prefers-color-scheme: light) {
                :root {
                    --bg: var(--bg-light);
                    --fg: var(--fg-light);
                    --border: var(--border-light);
                    --panel-bg: rgba(255, 255, 255, 0.75);
                    --panel-border: rgba(0, 0, 0, 0.08);
                    --btn-bg: var(--btn-bg-light);
                    --btn-bg-hover: #eef1f5;
                    --btn-bg-active: #e2e6eb;
                    --info-color: #333;
                    --subtitle-color: #555;
                }
            }
            @media (prefers-color-scheme: dark) {
                :root {
                    --bg: var(--bg-dark);
                    --fg: var(--fg-dark);
                    --border: var(--border-dark);
                    --panel-bg: rgba(40, 40, 44, 0.68);
                    --panel-border: rgba(255, 255, 255, 0.08);
                    --btn-bg: var(--btn-bg-dark);
                    --btn-bg-hover: #353b42;
                    --btn-bg-active: #40464e;
                    --info-color: #e0e0e0;
                    --subtitle-color: #a8a8a8;
                }

                #pdf-canvas {
                    filter: invert(0.87);
                }

                canvas {
                    filter: invert(0.87);
                }
            }

            html,
            body {
                margin: 0;
                padding: 0;
                font-family:
                    system-ui,
                    -apple-system,
                    Segoe UI,
                    Roboto,
                    Ubuntu,
                    Cantarell,
                    "Noto Sans",
                    Arial,
                    sans-serif;
                background: var(--bg);
                color: var(--fg);
                -webkit-font-smoothing: antialiased;
                height: 100vh;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            #controls.toolbar {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                align-items: center;
                padding: 10px 14px;
                background: var(--panel-bg);
                backdrop-filter: blur(14px) saturate(1.4);
                -webkit-backdrop-filter: blur(14px) saturate(1.4);
                border-bottom: 1px solid var(--panel-border);
                box-shadow:
                    0 4px 14px -4px var(--shadow-color-light),
                    0 2px 4px -1px var(--shadow-color-light);
                transition: background 0.35s;
                position: relative;
                z-index: 10;
            }
            @media (prefers-color-scheme: dark) {
                #controls.toolbar {
                    box-shadow:
                        0 4px 18px -6px var(--shadow-color-dark),
                        0 2px 6px -2px var(--shadow-color-dark);
                }
            }

            button,
            select,
            input[type="color"] {
                font: inherit;
                border: 1px solid var(--border);
                background: var(--btn-bg);
                color: var(--fg);
                padding: 8px 12px;
                border-radius: 10px;
                cursor: pointer;
                font-size: 14px;
                line-height: 1;
                display: inline-flex;
                align-items: center;
                gap: 8px;
                transition:
                    background 0.25s,
                    border-color 0.25s,
                    transform 0.15s;
                min-height: 40px;
            }
            button:focus-visible,
            select:focus-visible,
            input[type="color"]:focus-visible {
                outline: none;
                box-shadow: var(--focus-ring);
            }
            button:hover:not(:disabled),
            select:hover:not(:disabled),
            input[type="color"]:hover:not(:disabled) {
                background: var(--btn-bg-hover);
            }
            button:active:not(:disabled) {
                background: var(--btn-bg-active);
                transform: translateY(1px);
            }
            button:disabled {
                opacity: 0.55;
                cursor: not-allowed;
            }

            .icon-btn {
                padding-inline: 14px;
                font-weight: 500;
            }
            .icon-btn .label {
                font-size: 13px;
                letter-spacing: 0.3px;
            }
            .icon-btn i {
                font-size: 15px;
                width: 16px;
                text-align: center;
            }

            .select-cluster {
                display: flex;
                align-items: center;
                gap: 14px;
                flex-wrap: wrap;
            }
            .select-group {
                display: flex;
                align-items: center;
                gap: 8px;
                background: var(--btn-bg);
                border: 1px solid var(--border);
                padding: 4px 10px;
                border-radius: 12px;
                transition:
                    background 0.25s,
                    border-color 0.25s;
            }
            .select-group:hover {
                background: var(--btn-bg-hover);
            }
            .select-group:focus-within {
                box-shadow: var(--focus-ring);
            }
            .select-group i {
                font-size: 15px;
                opacity: 0.85;
            }
            .select-group select {
                background: transparent;
                border: none;
                padding: 0;
                font-size: 13px;
                height: 26px;
            }
            .select-group select:focus {
                outline: none;
                box-shadow: none;
            }

            .sr-only {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0 0 0 0);
                white-space: nowrap;
                border: 0;
            }

            #info-box,
            #tts-status {
                text-align: center;
                font-size: 13px;
                padding: 4px 10px;
                color: var(--info-color);
                min-height: 20px;
            }

            #viewer-region {
                flex: 1 1 auto;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                position: relative;
                margin: 10px;
            }

            #viewer-wrapper {
                flex: 1 1 auto;
                display: flex;
                justify-content: center;
                overflow: auto;
                padding: 3px 0 24px;
            }
            #pdf-canvas {
                border: 1px solid var(--border);
                border-radius: 14px;
                background: var(--bg);
                display: block;
                box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.25);
                max-width: calc(100vw - 40px);
            }

            #pdf-doc-container {
                flex: 1 1 auto;
                position: relative;
                overflow-y: auto;
                overflow-x: hidden;
                background: var(--bg);
                padding: 24px 0 48px;
                margin: 0;
                border-top: 1px solid var(--panel-border);
                scroll-behavior: smooth;
            }
            .pdf-page-wrapper {
                position: relative;
                margin: 0 auto 32px auto;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
                background: #fff;
                border-radius: 6px;
                overflow: hidden;
                transition: box-shadow 0.25s;
            }
            .pdf-page-wrapper:hover {
                box-shadow: 0 4px 14px rgba(0, 0, 0, 0.25);
            }
            .pdf-word-highlight {
                position: absolute;
                background: rgba(255, 255, 0, 0.28);
                pointer-events: none;
                border-radius: 2px;
            }

            /* Persistent highlight overlay (full doc mode) */
            .persistent-highlight {
                position: absolute;
                opacity: 0.45;
                mix-blend-mode: multiply;
                border-radius: 2px;
                pointer-events: none;
            }
            .persistent-highlight.current-playing {
                outline: 2px solid #ff9800;
            }

            /* Auto-highlight button active state */
            button[data-enabled="true"] {
                background: var(--accent-solid) !important;
                color: white !important;
                border-color: var(--accent-solid) !important;
            }

            #drop-overlay {
                position: fixed;
                inset: 0;
                background: radial-gradient(circle at 50% 50%, rgba(0, 150, 255, 0.25), rgba(0, 150, 255, 0.1));
                border: 3px dashed #0096ff;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: clamp(1.5rem, 3.5vw, 2.4rem);
                font-weight: 600;
                color: #0096ff;
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.25s ease;
                z-index: 1000;
                backdrop-filter: blur(6px);
            }
            #drop-overlay.active {
                opacity: 1;
            }

            .toolbar .btn-group {
                display: flex;
                gap: 8px;
                align-items: stretch;
            }
            .toolbar .spacer {
                flex: 1 1 auto;
                min-width: 40px;
            }

            @media (max-width: 680px) {
                html,
                body {
                    overflow: auto !important;
                    font-size: 15px;
                    height: 100dvh;
                }
                #controls.toolbar {
                    flex-direction: column;
                    align-items: stretch;
                    padding: 8px 4px;
                    gap: 4px;
                }
                .toolbar .btn-group,
                .select-cluster {
                    width: 100%;
                    justify-content: center;
                    gap: 4px;
                    flex-wrap: wrap;
                }
                .icon-btn .label {
                    display: none;
                }
                button,
                select,
                input[type="color"] {
                    flex: 1;
                    min-height: 46px;
                    font-size: 16px;
                }
                #viewer-region {
                    margin: 0;
                    padding: 0;
                }
            }

            body,
            html {
                overflow: auto !important;
                min-height: 100dvh;
                height: 100dvh;
            }
        </style>
    </head>
    <body>
        <script>
            if ("serviceWorker" in navigator) {
                navigator.serviceWorker
                    .register("service-worker.js")
                    .then((reg) => console.log("Service Worker registrado:", reg.scope))
                    .catch((err) => console.error("Erro no Service Worker:", err));
            }
        </script>

        <div id="controls" class="toolbar">
            <div class="btn-group">
                <button id="open-file" class="icon-btn" title="Open PDF (File Dialog)">
                    <i id="pdf-open" class="fa-solid fa-folder-open"></i>
                </button>
                <button id="export-highlights" class="icon-btn" title="Export PDF with highlights">
                    <i class="fa-solid fa-floppy-disk"></i>
                </button>
                <button id="toggle-view-mode" class="icon-btn" title="Toggle Full Document / Single Page">
                    <i class="fa-solid fa-clone"></i>
                </button>
                <button id="toggle-fullscreen" class="icon-btn" title="Toggle Full Screen">
                    <i class="fa-solid fa-expand"></i>
                </button>
            </div>

            <div class="btn-group">
                <button id="prev-page" class="icon-btn" title="Previous Page">
                    <i class="fa-solid fa-circle-left"></i>
                </button>
                <button id="prev-sentence" class="icon-btn" title="Previous Sentence (Arrow Left)">
                    <i class="fa-solid fa-backward" aria-hidden="true"></i>
                </button>
                <button id="play-toggle" class="icon-btn" data-state="play" title="Play / Pause (Space)">
                    <i class="fa-solid fa-play" aria-hidden="true" id="play-toggle-icon"></i>
                </button>
                <button id="next-sentence" class="icon-btn" title="Next Sentence (Arrow Right)">
                    <i class="fa-solid fa-forward" aria-hidden="true"></i>
                </button>
                <button id="next-page" class="icon-btn" title="Next Page">
                    <i class="fa-solid fa-circle-right"></i>
                </button>
            </div>

            <!-- NEW Highlight Controls -->
            <div class="btn-group" style="flex-wrap: wrap; gap: 6px">
                <input
                    style="margin-left: 20px; width: 50px; height: 5px"
                    type="color"
                    id="highlight-color"
                    value="#ffeb3b"
                    title="Highlight Color"
                    aria-label="Highlight Color"
                />
                <button id="save-highlight" class="icon-btn" title="Save current sentence highlight">
                    <i class="fa-solid fa-highlighter"></i>
                </button>
            </div>

            <div class="spacer" aria-hidden="true"></div>

            <div class="select-cluster">
                <div class="select-group" title="Voice">
                    <i id="mic-icon" class="fa-solid fa-spin fa-spinner" aria-hidden="true"></i>
                    <label for="voice-select" class="sr-only">Voice</label>
                    <select id="voice-select" aria-label="Voice"></select>
                </div>
                <div class="select-group" title="Playback Speed">
                    <i class="fa-solid fa-gauge-high" aria-hidden="true"></i>
                    <label for="rate-select" class="sr-only">Playback Speed</label>
                    <select id="rate-select" aria-label="Playback Speed">
                        <option value="1.0" selected>1.0x</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                        <option value="1.75">1.75x</option>
                        <option value="2.0">2.0x</option>
                    </select>
                </div>
            </div>
        </div>

        <div style="display: flex; gap: 10px">
            <div id="info-box" style="padding: 10px; flex: 1"></div>
            <div id="tts-status" style="padding: 10px; flex: 1"></div>
        </div>

        <div id="viewer-region">
            <div id="viewer-wrapper">
                <canvas id="pdf-canvas"></canvas>
            </div>
            <div id="pdf-doc-container" style="display: none"></div>
        </div>

        <input type="file" id="file-input" accept="application/pdf" style="display: none" />

        <div id="drop-overlay">Drop a PDF to read it!</div>

        <script type="module" src="render.js"></script>
        <script>
            const dropOverlay = document.getElementById("drop-overlay");
            let dragCounter = 0;
            window.addEventListener("dragenter", (e) => {
                e.preventDefault();
                dragCounter++;
                dropOverlay.classList.add("active");
            });
            window.addEventListener("dragover", (e) => e.preventDefault());
            window.addEventListener("dragleave", (e) => {
                e.preventDefault();
                dragCounter = Math.max(0, dragCounter - 1);
                if (!dragCounter) dropOverlay.classList.remove("active");
            });
            window.addEventListener("drop", async (e) => {
                e.preventDefault();
                dragCounter = 0;
                dropOverlay.classList.remove("active");
                const file = e.dataTransfer.files[0];
                if (file && /\.pdf$/i.test(file.name)) {
                    if (window.loadPDF) await window.loadPDF(file);
                } else alert("Not a valid PDF file!");
            });

            const fileInput = document.getElementById("file-input");
            document.getElementById("open-file").addEventListener("click", () => fileInput.click());
            fileInput.addEventListener("change", async (e) => {
                const file = e.target.files[0];
                if (file && /\.pdf$/i.test(file.name)) {
                    if (window.loadPDF) await window.loadPDF(file);
                } else alert("Not a valid PDF file!");
            });

            document.getElementById("toggle-view-mode").addEventListener("click", () => {
                if (window.toggleViewMode) window.toggleViewMode();
            });

            window.addEventListener("DOMContentLoaded", async () => {
                if (window.initializePdfApp) await window.initializePdfApp();
                else if (window.loadPDF) await window.loadPDF();
            });
        </script>
        <script>
            let wakeLock = null;
            const btn = document.getElementById("toggle-fullscreen");
            btn.addEventListener("click", () => {
                toggleFullscreen();
            });

            async function toggleFullscreen() {
                const doc = window.document;
                const docEl = doc.documentElement;
                const requestFull =
                    docEl.requestFullscreen ||
                    docEl.mozRequestFullScreen ||
                    docEl.webkitRequestFullscreen ||
                    docEl.msRequestFullscreen;
                const exitFull =
                    doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

                if (
                    !doc.fullscreenElement &&
                    !doc.mozFullScreenElement &&
                    !doc.webkitFullscreenElement &&
                    !doc.msFullscreenElement
                ) {
                    await requestFull.call(docEl);
                    enableWakeLock();
                } else {
                    await exitFull.call(doc);
                    disableWakeLock();
                }
            }

            async function enableWakeLock() {
                try {
                    if ("wakeLock" in navigator) {
                        wakeLock = await navigator.wakeLock.request("screen");
                        wakeLock.addEventListener("release", () => {});
                    }
                } catch (err) {
                    console.error(`${err.name}, ${err.message}`);
                }
            }
            function disableWakeLock() {
                if (wakeLock) {
                    wakeLock.release();
                    wakeLock = null;
                }
            }
        </script>
    </body>
</html>
